name: Build and Publish

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0     

    - name: Set up .NET
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: '8.x'

    - name: Install GitVersion
      run: dotnet tool install --global GitVersion.Tool

    - name: Determine version
      run: dotnet-gitversion /output buildserver
      id: gitversion

    - name: Update .csproj
      shell: pwsh 
      run: | 
          $tagCount = (git tag | Measure-Object).Count
          Update-Csproj.ps1 -CsprojPath ${{ github.workspace }}/CountingWhiz20/CountingWhiz20.csproj -DisplayVersion ${{ env.GitVersion_MajorMinorPatch }} -VersionCode $tagCount
 
    - name: Decode keystore file
      shell: pwsh
      run: |
        $KeystoreBase64 = '${{ secrets.ANDROID_SIGNING_KEYSTORE_BASE64 }}'
        $KeystoreBytes = [System.Convert]::FromBase64String($KeystoreBase64)
        [System.IO.File]::WriteAllBytes("${{ github.workspace }}\code-signing.keystore", $KeystoreBytes)

    - name: Create password file
      shell: pwsh
      run: |
        $Password = '${{ secrets.ANDROID_SIGNING_KEYSTORE_PASS }}'
        $Password | Out-File -FilePath "${{ github.workspace }}\AndroidSigningPassword.txt" -Encoding utf8 -NoNewline

    - name: Install MAUI workloads
      run: dotnet workload install maui maui-android

    - name: Build
      run: dotnet build --configuration Release

    - name: Upload the artifact
      uses: actions/upload-artifact@v3
      with:
        name: signed-artifacts
        path: |
          ${{ github.workspace }}/CountingWhiz20/bin/Release/net8.0-android/*-Signed.aab
          ${{ github.workspace }}/CountingWhiz20/bin/Release/net8.0-android/*-Signed.apk

    # RELEASE STUB
    #- name: Create GitHub Release
    #  id: create_release
    #  uses: actions/create-release@v1
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #  with:
    #    tag_name: ${{ github.ref }}
    #    release_name: Release ${{ github.ref }}
    #    body: |
    #      Changes in this release:
    #      - Description of changes
    #
    #- name: Upload Release Asset
    #  uses: actions/upload-release-asset@v1
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #  with:
    #    upload_url: ${{ steps.create_release.outputs.upload_url }}
    #    asset_path: ${{ github.workspace }}/CountingWhiz20/bin/Release/net8.0-android/*-Signed.aab
    #    asset_name: signed.aab
    #    asset_content_type: application/vnd.android.package-archive